
\iffalse
Consider $f: \mathbb{R}^d \mapsto \mathbb{R}^\ell$
$$
f(x_1, \cdots, x_d) = \langle f_1(x_1, \cdots, x_d), f_2(x_1, \cdots, x_d), \cdots, f_\ell(x_1, \cdots, x_d)\rangle.
$$ 
\begin{lemma}
Suppose $|x|\le T$. There exists
\begin{equation}
f(x) = \sum_{|\alpha|\le m}{1\over \alpha!}D^\alpha f(0) x^\alpha
+ {1\over m!}\int_{\{-1,1\}\times [0,T]\times \mathbb{R}^{d}}  g(x, \theta)\lambda(\theta)d\theta.  
\end{equation}  
with  $g(x,\theta)$ and $\lambda(\theta)$ defined in \eqref{eq:straglam}.
\end{lemma}
\begin{proof}
Let $G=\{-1,1\}\times \{1, 2, \cdots, \ell\}\times [0,T]\times \mathbb{R}^{d}$, $\theta=(z, r, t, \omega)\in G$. For each $f_r(x)$ ($r\in \{1,2 ,\cdots,\ell\}$), $\hat{f}_r(\omega)=|\hat{f}_r(\omega)|e^{ib(r, \omega)}$. Define
\begin{equation} 
g(x,\theta)= (z\bar \omega\cdot x - t)_+^m {\rm sgn} s(zt,r,\omega),\qquad \lambda(\theta)={\rho(\theta)\over 
\int_{G} \rho(\theta)d\theta}
\end{equation}
with $\rho(\theta) = |s(zt,r,\omega)||\hat{f}_r(\omega)|\|\omega\|_{\ell_1}^{m+1}$ and
\begin{equation} 
s(zt, r,\omega)= 
\begin{cases}
(-1)^{m+1\over 2}\cos(z\|\omega\|_{\ell_1}t + b(r, \omega)) & m \text{ is odd}
\\
(-1)^{m+2\over 2}\sin(z\|\omega\|_{\ell_1}t + b(r, \omega)) & m \text{ is even}.
\end{cases}
\end{equation}   
A similar argument to the one in Lemma \ref{lm:probabilityexpan} gives
\begin{equation} 
\sum_{r=1}^\ell \big (f_r(x) - \sum_{|\alpha|\le m}{1\over \alpha!}D^\alpha f_r(0) x^\alpha\big )
={1\over m!}\int_G  g(x, \theta)\lambda(\theta)d\theta.  
\end{equation}    
\end{proof}

\fi

\begin{theorem}\label{lem:stratifiedapprox2}
Suppose $\|x\|_{\ell_p}\le T$ and $f\in \mathcal{B}^{m+1, q}(\Omega)$.
%$$
% \int_{\mathbb{R}^{d}} |\hat{f}(\omega)|\|\omega\|_{\ell_q}^{m+1} d\omega<\infty.
%$$
There exist $\beta_j\in \{-1, 1\}$, $\|\bar \omega_j\|_{\ell_q}=1$, $t\in [0,T]$ such that 
$$
f_n(x)= \sum_{|\alpha|\le m}{1\over \alpha!}D^\alpha f(0) x^\alpha + {\nu\over m!n}\sum_{j=1}^{n}\beta_j (\bar \omega_j\cdot x - t_j)_+^m
$$ 
with $\nu=\int_{\{-1,1\}\times [0,T]\times \mathbb{R}^{d}} \rho(\theta)d\theta$ and $\rho(\theta)$  defined in \eqref{eq:straglam} 
satisfies the following estimate
\begin{equation}
\|f - f_n \|_{H^k(\Omega)} \leq C(m,k,\Omega) n^{-{1\over 2}-{1\over d+2}}\|f\|_{\mathcal B^{m+1, q}(\Omega)},\qquad k\le m.
\end{equation} 
Especially,
\begin{equation}
\|f - f_n \|_{L^2(\Omega)} \leq {(2T)^m|\Omega|^{1\over 2}\over (m-1)!} n^{-{1\over 2}-{1\over d+2}}\|f\|_{\mathcal B^{m+1, q}(\Omega)}.
\end{equation} 
%\begin{equation}
%\|D^\beta (f(x)- f_n(x))\|_{L^2(\Omega)}\le \sqrt{2^{m-k-2}(2m-k)\over k!(m-k)!}|\Omega|^{1/2} n^{-{1\over 2}-{1\over d}},\quad |\beta|=k\le m.
%\end{equation}
\end{theorem} 
\begin{proof}
Let 
$$
r_{m, n}(x)={1\over n}\sum_{j=1}^{n}\beta_j (\bar \omega_j\cdot x - t_j)_+^m
$$
Recall the representation  of $f(x)$ in \eqref{ReLUm} and $r_m(x)$ in \eqref{ReLUrm}
\begin{equation}
r_m(x) = \int_{\{-1,1\}\times [0,T]\times \mathbb{R}^{d}}  g(x, \theta)\lambda(\theta)d\theta  
\end{equation} 
in Lemma \ref{lm:probabilityexpan} with  $g(x,\theta)$ and $\lambda(\theta)$ defined in \eqref{eq:straglam}. There exists
$$
f(x) - f_n(x)= {\nu\over m!}(r_m(x) - r_{m, n}(x)).
$$ 
As analyzed in Lemma \ref{est:stratify}, there exists a partition $G=G_1\cup \cdots \cup G_M$ such that
$$
|t -t'| + \|\bar\omega - \bar\omega'\|_{\ell_q}\leq \epsilon \le C M^{-{1\over d}},\quad \forall 1\le i\le M.
$$ 
Let  $\theta_{i,j} \in G_i(1\leq j\leq n_i)$,  $n_i$ equal $\lceil \lambda(G_i)n\rceil$ and $\lfloor \lambda(G_i)n\rfloor$ with probabilities chosen to make its mean equal to $\lambda(G_i)n$ and $m_i=n_i + \mathbb{I}(n_i=0)$. Then
\begin{align} 
\sum_{i=1}^M m_i&=\sum_{i=1}^M n_i\mathbb{I}(n_i>0) + \sum_{i=1}^M n_i\mathbb{I}(n_i=0)
\\
&\le \sum_{i=1}^M (n\lambda(G_i) + 1)\mathbb{I}(n_i>0) + \sum_{i=1}^M \mathbb{I}(n_i=0)
\\
&\le  n\sum_{i=1}^M \lambda(G_i)\mathbb{I}(n_i>0) + M
\le n+M.
\end{align} 
Define $\displaystyle N=\sum_{i=1}^Mn_i$  and
$$
r_{m,n}(x)= {1\over N}\sum_{i=1}^M {n_i\over m_i} \sum_{j=1}^{m_i} g(x,\theta_{i,j}).
$$
By the definition of $m_i$, $\displaystyle {n_i\over m_i}=0$ or $1$.  This means that $r_{m,n}(x) $ is in the form of  $\displaystyle {1\over N}\sum_{i=1}^Ng(x,\theta_i)$.  Define
$$
\bar{r}_{m,n}(x)= \sum_{i=1}^M {n_i\over N}\mathbb{E}_{G_i}g.
$$
Since
$
\displaystyle r_m(x)=\mathbb{E}_G g= \sum_{i=1}^M \lambda(G_i) \mathbb{E}_{G_i}g,
$  
\begin{align}  
r_{m,n} - r_m  &= r_{m,n} - \bar{r}_{m,n} + \bar{r}_{m,n} - r_m
\\
&= {1\over N}\sum_{i=1}^M {n_i\over m_i} \sum_{j=1}^{m_i} \big (g(x,\theta_{i,j}) - \mathbb{E}_{G_i}g \big ) + {1\over N}\sum_{i=1}^M (n_i - \lambda(G_i)N)  \mathbb{E}_{G_i}g.
\end{align} 
\iffalse
It follows that 
\begin{align}  
\|f_n - f \|_{L^2(\Omega)}^2 &\le {1\over N^2}\sum_{i=1}^M {n_i\over m_i} \sum_{j=1}^{m_i} \|g(x,\theta_{i,j}) - \mathbb{E}_{G_i}g \|_{L^2(\Omega)}^2 + \big ({1\over N}\sum_{i=1}^M (n_i - \lambda(G_i)N)  \mathbb{E}_{G_i}g\big )^2|\Omega|
\\
&\le {1\over N^2}\sum_{i=1}^M {n_i\over m_i} \sum_{j=1}^{m_i} \sup_{\theta_{i, j},\theta_{i, j}'\in G_i} \| g(x,\theta_{i, j}) - g(x,\theta_{i,j}')\|^2_{L^2(\Omega)} 
+ \big ({1\over N}\sum_{i=1}^M (n_i - \lambda(G_i)N)  \mathbb{E}_{G_i}g\big )^2|\Omega|
\\
&\le {1\over N^2}\sum_{i=1}^M n_i\sup_{\theta_{i, j},\theta_{i, j}'\in G_i} \| g(x,\theta_{i, j}) - g(x,\theta_{i,j}')\|^2_{L^2(\Omega)}
+ \big ({1\over N}\sum_{i=1}^M (n_i - \lambda(G_i)N)  \mathbb{E}_{G_i}g\big )^2|\Omega|
\\
&\le {1\over N} \max_{1\le i\le M}\sup_{\theta_{i, j},\theta_{i, j}'\in G_i} \| g(x,\theta_{i, j}) - g(x,\theta_{i,j}')\|^2_{L^2(\Omega)}
+ \big ({1\over N}\sum_{i=1}^M ({n_i\over \lambda(G_i)} - N)  \int_{G_i}g\lambda(\theta)d\theta\big )^2|\Omega|.
\end{align} 
Consider the last term on the right-hand side of the above equation. By the definition of $N$, $|n-N|\le M$. 
Thus,
\begin{align}  
\|f_n - f \|_{L^2(\Omega)}^2 \le& {1\over N} \max_{1\le i\le M}\sup_{\theta_{i, j},\theta_{i, j}'\in G_i} \| g(x,\theta_{i, j}) - g(x,\theta_{i,j}')\|^2_{L^2(\Omega)}
+ {M^2\over N^2} \big (\mathbb{E}_{G}g \big )^2|\Omega|
\\
&
+ \big ({1\over N}\sum_{i=1}^M ({n_i\over \lambda(G_i)} - n)  \int_{G_i}g\lambda(\theta)d\theta\big )^2|\Omega|.
\end{align} 
It follows that 
\begin{align}  
\mathbb{E}_n \|f_n - f \|_{L^2(\Omega)}^2 
\le &{1\over N} \max_{1\le i\le M}\sup_{\theta_{i, j},\theta_{i, j}'\in G_i} \| g(x,\theta_{i, j}) - g(x,\theta_{i,j}')\|^2_{L^2(\Omega)}
+ {M^2\over N^2} \big (\mathbb{E}_{G}g \big )^2|\Omega|\label{stratify2t}.
\end{align}   
Note that 
$$
\displaystyle \left |{1\over N}\sum_{i=1}^M ({n_i\over \lambda(G_i)} - n)  \int_{G_i}g\lambda(\theta)d\theta \right |
\le {1\over N\min_{1\le i\le M}\lambda(G_i)}  \int_{G} |g|\lambda(\theta)d\theta .
$$
It follows that
\begin{align}  
\mathbb{E}_n \|f_n - f \|_{L^2(\Omega)}^2 
\le &{1\over N} \max_{1\le i\le M}\sup_{\theta_{i, j},\theta_{i, j}'\in G_i} \| g(x,\theta_{i, j}) - g(x,\theta_{i,j}')\|^2_{L^2(\Omega)} + {M^2\over N^2} (\mathbb{E}_{G}g )^2|\Omega|
\\
&+{1\over N^2\min_{1\le i\le M}\lambda^2(G_i)}  \left (\int_{G} |g|\lambda(\theta)d\theta\right )^2.
\end{align}  
Consequently,
\begin{align}  
\mathbb{E}_n \|f_n - f \|_{L^2(\Omega)}^2 
\le &{\epsilon^2 \over N} + {M^2\over N^2} (\mathbb{E}_{G}g )^2|\Omega|.
\end{align}  
Choose $\displaystyle {\epsilon^2 \over N} = {M^2\over N^2} (\mathbb{E}_{G}g )^2|\Omega|$, then $M^2\sim N\epsilon^2$ and 
$$
\mathbb{E}_n \|f_n - f \|_{L^2(\Omega)}^2 \le {2\epsilon^2 \over N}.
$$
Since $M\sim \epsilon^{-d}$, then $N\sim \epsilon^{-d-2}$ and 
$$
\mathbb{E}_n \|f_n - f \|_{L^2(\Omega)}^2 \lesssim N^{-1-{2\over d+2}}.
$$
There exist $\{\theta_{i,j}^\ast\}$ such that $\theta_{i,j}^\ast\in G_i$ and 
\begin{equation}
\| f -  f_n \|_{L^2(\Omega)}\lesssim N^{-{1\over 2}-{1\over d+2}}.
\end{equation}
which completes the proof. 

\fi
It follows that  
\begin{align}  
\|r_{m,n} - r_m \|_{L^2(\Omega)}^2 &\le {1\over N^2}\sum_{i=1}^M {n_i\over m_i} \sum_{j=1}^{m_i} \|g(x,\theta_{i,j}) - \mathbb{E}_{G_i}g \|_{L^2(\Omega)}^2 +  {1\over N^2}\sum_{i=1}^M (n_i - \lambda(G_i)N)^2  \|\mathbb{E}_{G_i}g\|_{L^2(\Omega)}^2.
\end{align} 
For the first term on the right-hand side of the above equation,
\begin{align}  
{1\over N^2}\sum_{i=1}^M {n_i\over m_i} \sum_{j=1}^{m_i} \|g(x,\theta_{i,j}) - \mathbb{E}_{G_i}g \|_{L^2(\Omega)}^2 \le {1\over N^2}\sum_{i=1}^M {n_i\over m_i} \sum_{j=1}^{m_i} \sup_{\theta_{i, j},\theta_{i, j}'\in G_i} \| g(x,\theta_{i, j}) - g(x,\theta_{i,j}')\|^2_{L^2(\Omega)} .
\end{align} 
Recall 
$
g(x, \theta)= (z\bar \omega\cdot x - t)_+^m {\rm sgn} s(zt,\omega),
$
which is bounded, say $|g(x,\theta)|\le C$. Note that $|n-N|\le M$. Thus,
\begin{align}
 {1\over N^2}\sum_{i=1}^M (n_i - \lambda(G_i)N)^2  \|\mathbb{E}_{G_i}g\|_{L^2(\Omega)}^2& \le {1 \over N^2}\sum_{i=1}^M  (M^2 + {1\over \lambda^2(G_i)}) \int_\Omega \int_{G_i} g^2(x,\theta)\lambda^2(\theta)d\theta d\mu(x)
\\
&\le  {C^2|\Omega|\over N^2}(M^2 +M)\le {\tilde C\over N^2}M^2.
\end{align}  
It follows that 
\begin{align}  
\mathbb{E}_n \|r_{m,n} - r_m \|_{L^2(\Omega)}^2 
\le &{1\over N} \max_{1\le i\le M}\sup_{\theta_{i, j},\theta_{i, j}'\in G_i} \| g(x,\theta_{i, j}) - g(x,\theta_{i,j}')\|^2_{L^2(\Omega)}
+ {\tilde C\over N^2}M^2 
\le {\epsilon^2 \over N} + {\tilde C\over N^2}M^2\label{stratify2t}.
\end{align}  
Choose $\displaystyle {\epsilon^2 \over N} = {\tilde C\over N^2}M^2$, then $M^2\sim N\epsilon^2$ and 
$$
\mathbb{E}_n \|r_{m,n} - r_m \|_{L^2(\Omega)}^2 \le {2\epsilon^2 \over N}.
$$
Since $M\sim \epsilon^{-d}$, then $N\sim \epsilon^{-d-2}$ and 
$$
\mathbb{E}_n \|r_{m,n} - r_m \|_{L^2(\Omega)}^2 \lesssim N^{-1-{2\over d+2}}.
$$
There exist $\{\theta_{i,j}^\ast\}$ such that $\theta_{i,j}^\ast\in G_i$ and 
\begin{equation}
\| f -  f_n \|_{L^2(\Omega)}\le {\nu\over m!}\|r_{m,n} - r_m\|_{L^2(\Omega)}\lesssim N^{-{1\over 2}-{1\over d+2}}\|f\|_{\mathcal B^{m+1, q}(\Omega)}.
\end{equation}
which completes the proof. 

\end{proof}
